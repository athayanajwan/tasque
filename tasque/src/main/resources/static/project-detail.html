<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Detail Proyek</title>
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
  <style>
  .bar-project {
    fill: #8884d8 !important;
    stroke: #333;
    stroke-width: 1;
  }
 
  #userPreviewModal button {
    margin-left: 10px;
    padding: 8px 12px;
    cursor: pointer;
  }
  </style>
</head>
<body>
    
    
  <h2>Detail Proyek</h2>
  <div id="userRole" style="margin: 10px 0; padding: 10px; background: #f5f5f5;">
  <!-- Role akan muncul di sini -->
</div>
  <div id="projectDetails">Memuat data...</div>
  
  <hr>
    <label for="tagFilter">Filter Tag:</label>
    <select id="tagFilter">
        <option value="">-- Semua Tag --</option>
    </select>
    <h3>Daftar Tugas</h3>
    <div id="taskList">Memuat tugas...</div>
  
    <div id="taskStats" style="margin: 20px 0;">
  <h4>Progress Proyek</h4>
  <div id="progressBarContainer" style="background: #eee; border-radius: 5px; height: 25px; width: 100%; margin-bottom: 10px;">
    <div id="progressBar" style="background: #4caf50; height: 100%; width: 0%; border-radius: 5px;"></div>
  </div>
  <p id="progressText"></p>
  <ul id="taskSummary">
    <li>To Do: <span id="todoCount">0</span></li>
    <li>In Progress: <span id="inProgressCount">0</span></li>
    <li>Done: <span id="doneCount">0</span></li>
  </ul>
</div>
    
    <div id="ganttContainer" style="overflow-x: auto; margin-top: 30px;">
  <h4>Timeline / Gantt Chart</h4>
  <div id="gantt" style="min-height: 300px;"></div>
</div>
    
  <div id="projectActions" style="display:none;">
    <h3>Edit Proyek</h3>
    <form id="editProjectForm">
      <input type="text" id="editName" placeholder="Nama Proyek" required>
      <input type="text" id="editDescription" placeholder="Deskripsi" required>
      <input type="datetime-local" id="editDeadline" required>
      <button type="submit">Simpan Perubahan</button>
    </form>

    <h3>Kelola Anggota</h3>
    <ul id="memberList"></ul>

    <h4>Undang Anggota Baru</h4>
    <form id="inviteForm">
      <input type="text" id="inviteUsername" placeholder="username" required>
      <select id="inviteRole">
        <option value="PROJECT_MANAGER">Project Manager</option>
        <option value="MEMBER">Anggota</option>
      </select>
      <button type="submit">Undang</button>
    </form>

    <h3>Buat Tugas Baru</h3>
    <form id="createTaskForm">
        <input type="text" id="taskTitle" placeholder="Judul Tugas" required>
        <textarea id="taskDescription" placeholder="Deskripsi" required></textarea>
        <input type="text" id="assignedTo" placeholder="assignedTo" required>
        <select id="taskPriority" required>
            <option value="">--Pilih Prioritas--</option>
            <option value="LOW">Rendah</option>
            <option value="MEDIUM">Sedang</option>
            <option value="HIGH">Tinggi</option>
            <option value="URGENT">Urgent</option>
        </select>
        <select id="taskStatus" required>
            <option value="">--Pilih Status--</option>
            <option value="TO_DO">To Do</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="REVIEW">Review</option>
            <option value="COMPLETED">Selesai</option>
        </select>
        <input type="datetime-local" id="startInput" required>
        <input type="datetime-local" id="deadlineInput" required>    
        <input type="text" id="taskTags" placeholder="Tag (pisahkan dengan koma)">
        <button type="submit">Tambah Tugas</button>
    </form>
    
    <br>
    <button id="deleteBtn" style="background-color: red; color: white;">Hapus Proyek</button>
  </div>

  <a href="dashboard.html">← Kembali ke Dashboard</a>

  <script src="js/auth.js"></script>
  <script>
    if (!isAuthenticated()) {
      window.location.href = "login.html";
    }

    const token = localStorage.getItem("token");
    const projectId = new URLSearchParams(window.location.search).get("id");
    let currentUserId = null;
    let currentProject = null;
    let isManager = false;
    let ganttInstance = null;
    
    function renderTaskVisuals(tasks) {
  let todo = 0, inProgress = 0, done = 0;
  tasks.forEach(task => {
    if (task.status === "TO_DO") todo++;
    else if (task.status === "IN_PROGRESS" || task.status === "REVIEW") inProgress++;
    else if (task.status === "COMPLETED") done++;
  });

  const total = tasks.length;
  const percentDone = total > 0 ? Math.round((done / total) * 100) : 0;

  document.getElementById("todoCount").textContent = todo;
  document.getElementById("inProgressCount").textContent = inProgress;
  document.getElementById("doneCount").textContent = done;
  document.getElementById("progressBar").style.width = `${percentDone}%`;
  document.getElementById("progressText").textContent = `${percentDone}% tugas selesai`;

  const ganttTasks = [];

  // Tambahkan bar proyek
  if (currentProject?.start && currentProject?.deadline) {
    ganttTasks.push({
      id: `project-${currentProject.id}`,
      name: `[PROYEK] ${currentProject.name}`,
      start: new Date(currentProject.start).toISOString(),
      end: new Date(currentProject.deadline).toISOString(),
      progress: percentDone,
      custom_class: "bar-project"
    });
  }

  // Tambahkan task-task biasa
  ganttTasks.push(
    ...tasks
      .filter(task => task.deadline)
      .map(task => {
        let startDate = new Date(task.start || task.deadline);
        let endDate = new Date(task.deadline || task.start);

        if (isNaN(startDate)) startDate = new Date();
        if (isNaN(endDate)) endDate = new Date();

        return {
            id: task.id,
            name: task.title || "Untitled",
            start: startDate.toISOString(),
            end: endDate.toISOString(),
            progress:
                task.status === "COMPLETED" ? 100 :
                task.status === "IN_PROGRESS" ? 50 :
                task.status === "REVIEW" ? 75 :
                0,
            custom_class: "bar-" + (task.status?.toLowerCase() || "")
        };
      })
  );

  console.log("Gantt Tasks:", ganttTasks);

  // Bersihkan chart lama
  const ganttEl = document.getElementById("gantt");
  ganttEl.innerHTML = "";

  // Buat Gantt baru
  ganttInstance = new Gantt("#gantt", ganttTasks, {
    on_date_change: (task, start, end) => {
      if (task.id.startsWith("project-")) return; // Proyek tidak bisa digeser

      fetch(`http://localhost:8080/api/tasks/${task.id}`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + localStorage.getItem("token"),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          ...task,
          deadline: end.toISOString()
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("Gagal update tanggal");
        alert("Tanggal tugas diperbarui");
      })
      .catch(err => alert("Gagal update tanggal: " + err.message));
    }
  });
 }

    
    
    // Format ISO 8601 string ke format datetime-local (yyyy-MM-ddTHH:mm)
    function toDateTimeLocal(isoString) {
      const date = new Date(isoString);
      const pad = (num) => num.toString().padStart(2, '0');
      const yyyy = date.getFullYear();
      const MM = pad(date.getMonth() + 1);
      const dd = pad(date.getDate());
      const hh = pad(date.getHours());
      const mm = pad(date.getMinutes());
      return `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
    }

    // Format tanggal ke format lokal yang user-friendly
    function formatDateTime(iso) {
      const date = new Date(iso);
      return date.toLocaleString("id-ID", {
        weekday: 'long', year: 'numeric', month: 'long',
        day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    fetch("http://localhost:8080/api/users/me", {
        headers: { "Authorization": "Bearer " + token }
    })
    .then(res => {
        if (!res.ok) throw new Error("Gagal memuat data pengguna");
        return res.json();
    })
    .then(user => {
        currentUserId = user.id;

    return fetch(`http://localhost:8080/api/projects/${projectId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
    })
    .then(res => {
      if (!res.ok) throw new Error("Gagal memuat data proyek");
      return res.json();
    })
    .then(project => {
  currentProject = project;
  console.log("Project Data:", project); // Debug 1
  console.log("Current User ID:", currentUserId); // Debug 2
  
  const currentMember = project.members?.find(m => m.userId === currentUserId);
  console.log("Current Member:", currentMember); // Debug 3

  isManager = currentMember?.role === "PROJECT_MANAGER";
  console.log("Is Manager:", isManager); // Debug 4

  // Tampilkan role dengan pengecekan lebih ketat
  const userRoleElement = document.getElementById("userRole");
  if (userRoleElement) {
    if (currentMember) {
      userRoleElement.innerHTML = `<p><strong>Peran Anda:</strong> ${formatRole(currentMember.role)}</p>`;
    } else {
      userRoleElement.innerHTML = `<p style="color:red;">Anda bukan anggota proyek ini</p>`;
    }
  } else {
    console.error("Element dengan ID 'userRole' tidak ditemukan!");
  }
      document.getElementById("projectDetails").innerHTML = `
        <p><strong>Nama:</strong> ${project.name}</p>
        <p><strong>Deskripsi:</strong> ${project.description}</p>
        <p><strong>Dibuat oleh:</strong> ${project.createdBy}</p>
        <p><strong>Start:</strong> ${formatDateTime(project.start)}</p>
        <p><strong>Deadline:</strong> ${formatDateTime(project.deadline)}</p>
      `;

      if (isManager) {
        document.getElementById("projectActions").style.display = "block";

        document.getElementById("editName").value = project.name;
        document.getElementById("editDescription").value = project.description;
        document.getElementById("editDeadline").value = toDateTimeLocal(project.deadline); 
      }
      
      loadMembers(project.members);
      loadTasks();
    })
    .catch(err => {
      document.getElementById("projectDetails").textContent = "Gagal memuat data: " + err.message;
    });
    
    
    // Fungsi tampilkan anggota proyek
    function loadMembers(members) {
  const list = document.getElementById("memberList");
  list.innerHTML = "";
  members.forEach(member => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${member.username}</strong> - <em>${formatRole(member.role)}</em>`;

    // Hanya tampilkan tombol hapus jika current user adalah PROJECT_MANAGER
    // dan member bukan diri sendiri
    if (isManager && member.userId !== currentUserId) {
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "Hapus";
      removeBtn.style.marginLeft = "10px";
      removeBtn.onclick = () => {
        if (confirm(`Hapus ${member.username} dari proyek?`)) {
          fetch(`http://localhost:8080/api/projects/${projectId}/members?username=${encodeURIComponent(member.username)}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
          })
        .then(res => {
            if (res.ok) {
              alert("Anggota dihapus.");
              location.reload();
            } else {
              return res.clone().json() // clone agar bisa dipakai juga oleh .text()
                .then(err => {
                    throw new Error(err.message || "Terjadi kesalahan saat menghapus anggota.");
                })
                .catch(() => res.text().then(msg => {
                    // Jika bukan JSON, ambil isi text biasa
                    throw new Error(msg || "Terjadi kesalahan yang tidak diketahui.");
                }));
                }
            })
        .catch(err => alert("Gagal hapus anggota: " + err.message));
    }
    };
      li.appendChild(removeBtn);
    }

    list.appendChild(li);
  });
}

    function formatRole(role) {
        switch (role) {
        case "PROJECT_MANAGER":
            return "Project Manager";
        case "MEMBER":
            return "Anggota";
        default:
            return role;
        }
    }

    // Event edit proyek
    document.getElementById("editProjectForm").onsubmit = function(e) {
      e.preventDefault();
      const updated = {
        name: document.getElementById("editName").value,
        description: document.getElementById("editDescription").value,
        deadline: new Date(document.getElementById("editDeadline").value).toISOString()
      };

      fetch(`http://localhost:8080/api/projects/${projectId}`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(updated)
      })
      .then(res => {
        if (res.ok) {
          alert("Proyek berhasil diperbarui.");
          location.reload();
        } else {
          return res.text().then(msg => { throw new Error(msg); });
        }
      })
      .catch(err => alert("Gagal menyimpan perubahan: " + err.message));
    };

    document.getElementById("deleteBtn").addEventListener("click", async () => {
    if (!confirm("Yakin ingin menghapus proyek ini? Tindakan ini tidak dapat dibatalkan.")) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:8080/api/projects/${projectId}`, {
            method: "DELETE",
            headers: { 
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            }
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.message || "Gagal menghapus proyek");
        }

        alert("Proyek berhasil dihapus.");
        window.location.href = "dashboard.html";
    } catch (error) {
        console.error("Error deleting project:", error);
        alert(`Gagal menghapus proyek: ${error.message}`);
    }
});

    // Event undang anggota baru
    document.getElementById("inviteForm").onsubmit = function(e) {
  e.preventDefault();
  const username = document.getElementById("inviteUsername").value;
  const role = document.getElementById("inviteRole").value;

  // Ambil data user untuk preview
  fetch(`http://localhost:8080/api/users/${encodeURIComponent(username)}`, {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => {
    if (!res.ok) throw new Error("Pengguna tidak ditemukan");
    return res.json();
  })
  .then(user => {
    showUserPreviewModal(user, role);
  })
  .catch(err => {
    alert("Gagal memuat data pengguna: " + err.message);
  });
};

    
    function loadTasks(filterTag = "") {
  fetch(`http://localhost:8080/api/tasks?projectId=${projectId}`, {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => res.json())
  .then(tasks => {
    const taskListDiv = document.getElementById("taskList");
    taskListDiv.innerHTML = "";

    const tagFilter = document.getElementById("tagFilter");
    const uniqueTags = new Set();

    tasks.forEach(task => {
      if (task.tags) {
        task.tags.forEach(tag => uniqueTags.add(tag.name));
      }
    });

    // Isi dropdown jika belum ada option (hanya sekali saat pertama load)
    if (tagFilter.options.length <= 1) {
      uniqueTags.forEach(tag => {
        const opt = document.createElement("option");
        opt.value = tag;
        opt.textContent = tag;
        tagFilter.appendChild(opt);
      });
    }

    // Filter berdasarkan tag jika ada
    const filteredTasks = filterTag
      ? tasks.filter(task => task.tags && task.tags.some(tag => tag.name === filterTag))
      : tasks;

    renderTaskVisuals(tasks);

    if (filteredTasks.length === 0) {
      taskListDiv.textContent = "Tidak ada tugas.";
      return;
    }

    const ul = document.createElement("ul");
    filteredTasks.forEach(task => {
      const li = document.createElement("li");

      const taskLink = document.createElement("a");
      taskLink.href = `task-detail.html?id=${task.id}`;
      taskLink.textContent = task.title;
      taskLink.style.textDecoration = "underline";
      taskLink.style.color = "blue";

      li.appendChild(taskLink);

      // Tambahkan info tag (opsional)
      if (task.tags && task.tags.length > 0) {
        const tagSpan = document.createElement("span");
        tagSpan.textContent = " [Tag: " + task.tags.map(t => t.name).join(", ") + "]";
        tagSpan.style.marginLeft = "10px";
        li.appendChild(tagSpan);
      }

      const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "Hapus";
  deleteBtn.style.marginLeft = "10px";
  deleteBtn.onclick = () => {
    if (confirm("Apakah Anda yakin ingin menghapus tugas ini?")) {
      fetch(`http://localhost:8080/api/tasks/${task.id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      })
      .then(res => {
        if (!res.ok) throw new Error("Gagal menghapus");
        loadTasks(filterTag); // reload ulang daftar setelah hapus
      })
      .catch(err => alert("Error: " + err.message));
    }
  };
  li.appendChild(deleteBtn);

      ul.appendChild(li);
    });

    taskListDiv.appendChild(ul);
    
  })
  .catch(err => {
    document.getElementById("taskList").textContent = "Gagal memuat tugas: " + err.message;
  });
}

    document.getElementById("tagFilter").addEventListener("change", function() {
        const selectedTag = this.value;
        loadTasks(selectedTag);
    });



    document.getElementById("createTaskForm").onsubmit = async function (e) {
        e.preventDefault();
        
        const title = document.getElementById("taskTitle").value;
        const description = document.getElementById("taskDescription").value;
        const assignedTo = document.getElementById("assignedTo").value;
        const priority = document.getElementById("taskPriority").value;
        const status = document.getElementById("taskStatus").value;
        const deadline = new Date(document.getElementById("deadlineInput").value).toISOString();
        const start = new Date(document.getElementById("startInput").value).toISOString();
        const tagInput = document.getElementById("taskTags").value;

        const tagNames = tagInput
            .split(",")
            .map(tag => tag.trim())
            .filter(tag => tag.length > 0);

        const taskData = {
            title: title,
            description: description,
            status: status,
            priority: priority,
            assignedTo: assignedTo,
            deadline: deadline,
            start: start,
            projectId: projectId,
            tagNames: tagNames
        };
        console.log(taskData);
        console.log("Data yang dikirim:", taskData); // Debug

        fetch("http://localhost:8080/api/tasks", {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
                body: JSON.stringify(taskData)
            })
        .then(response => {
            console.log("Response status:", response.status);
    
            return response.text().then(text => {
                console.log("Response body:", text);

                // Periksa apakah response berhasil
                if (!response.ok) {
                    throw new Error("Gagal menambah task. Status: " + response.status);
                }

                // Parse isi JSON jika berhasil
                return JSON.parse(text);
            });
        })
        .then(task => {
            alert("Task berhasil ditambahkan.");
            document.getElementById("createTaskForm").reset();
            loadTasks();
        })
        .catch(error => {
            console.error("Error:", error);
            alert(error.message);
        });
    };
  

function deleteTask(taskId) {
  if (!confirm("Yakin ingin menghapus tugas ini?")) return;

  fetch(`http://localhost:8080/api/tasks/${taskId}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => {
    if (!res.ok) throw new Error("Gagal menghapus tugas");
    alert("Tugas berhasil dihapus");
    loadTasks(); // reload
  })
  .catch(err => {
    alert("Gagal menghapus tugas: " + err.message);
  });
}

function showUserPreviewModal(user, role) {
  const modal = document.createElement("div");
  modal.id = "userPreviewModal";
  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0, 0, 0, 0.5)";
  modal.style.display = "flex";
  modal.style.alignItems = "center";
  modal.style.justifyContent = "center";
  modal.style.zIndex = "9999";

  modal.innerHTML = `
    <div style="background: white; padding: 20px; border-radius: 10px; width: 400px;">
      <h3>Profil Pengguna</h3>
      <p><strong>Username:</strong> ${user.username}</p>
      <p><strong>Email:</strong> ${user.email || "-"}</p>
      <p><strong>Description:</strong> ${user.description || "-"}</p>
      <p><strong>Role:</strong> ${role}</p>
      <div style="margin-top: 20px; text-align: right;">
        <button id="confirmInviteBtn">➕ Tambah ke Proyek</button>
        <button id="cancelInviteBtn">❌ Batal</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Tombol batal
  document.getElementById("cancelInviteBtn").onclick = () => {
    modal.remove();
  };

  // Tombol tambah
  document.getElementById("confirmInviteBtn").onclick = () => {
    fetch(`http://localhost:8080/api/projects/${projectId}/members?username=${encodeURIComponent(user.username)}&role=${encodeURIComponent(role)}`, {
      method: "POST",
      headers: { "Authorization": "Bearer " + token }
    })
    .then(res => {
      if (res.ok) {
        alert("Berhasil ditambahkan.");
        location.reload();
      } else {
        return res.text().then(msg => { throw new Error(msg); });
      }
    })
    .catch(err => alert("Gagal menambahkan: " + err.message))
    .finally(() => modal.remove());
  };
}
  </script>
</body>
</html>
